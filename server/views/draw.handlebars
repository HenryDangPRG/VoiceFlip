<html>
    <head>
        <Title>Voice Flip</title>
        <script src="../resources/annyang.min.js"></script>
        <script src="../resources/axios.js"></script>

        <style>
            .nonSelectable {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none; 
                user-select: none; 
            }

            #pLastCommand {
                font-family: Helvetica, Arial, sans-serif;
                text-align: center;
                font-size: 300%;
                line-height: 0%;
            }

            .bordered {
                border: solid gray 3px;
                border-radius: 25px;
            }
        </style>
        <script>
            var canvas;
            var ctx;
            var lineWidth = 10;
            var strokeColor = "#000000";
            var pos = { x: 0, y: 0 };
            var flipbookName = "";

            const validColors = {
                "red": "#FF0000",
                "blue": "#0000FF",
                "green": "#00FF00"
            }

            const validSizes = {
                "very big": 40,
                "big": 20,
                "medium": 10,
                "small": 5,
                "very small": 2,
            };

            // Commands are checked from top to bottom, and since
            // the keys are non-integer, they are guaranteed to be in order
            const commands = {
                "size *width": changeSize,
                "color *color": changeColor, 
                "*unknown": unknownCommand,
            }

            function changeSize(size) {
                size = size.toLowerCase();
                if(size in validSizes) {
                    lineWidth = validSizes[size];
                    updateLastCommandText("size " + size);
                } else {
                    unknownCommand("size " + size);
                }
            }
            
            function unknownCommand(unknown) {
                updateLastCommandText("Unknown command: " + unknown);
            }
            function updateLastCommandText(text) {
                document.getElementById("pLastCommand").innerHTML = text;
            }

            function changeColor(color) {
                var command = "color " + color;
                if(color.toLowerCase() in validColors) {
                    strokeColor = validColors[color];
                    updateLastCommandText(command);
                } else {
                    updateLastCommandText("Unknown command: " + command);
                }
            }

            function init() {
                if(annyang) {
                    annyang.addCommands(commands);
                    annyang.start()
                }

                flipbookName = document.getElementById("spanFlipbookName").innerHTML.trim()
                this.fillMaxNumPages();
                console.log("Flipbook name is: " + flipbookName);
                canvas = document.getElementById("canvas");
                document.body.style.margin = 0;
                canvas.style.position = 'fixed';
                ctx = canvas.getContext('2d');
                height = window.innerHeight - 200;
                width = window.innerWidth - 200;
                ctx.canvas.width = width;
                ctx.canvas.height = height;
                ctx.lineCap = "round"

                document.getElementById("canvasDiv").setAttribute("style","width:" + width + "px");
                document.getElementById("canvasDiv").setAttribute("style","height:" + height + "px");
                document.addEventListener('mousemove', draw);
                document.addEventListener('mousedown', setPosition);
                document.addEventListener('mouseenter', setPosition);
                document.addEventListener('mouseup', exportCanvas);
                this.importCanvas();
            }

            // As soon as the user left clicks, pos is set to the current cursor position's
            // x and y
            function setPosition(e) {
              pos.x = e.clientX;
              pos.y = e.clientY;
            }

            function draw(e) {
              if (e.buttons !== 1) {
                  return;
              } 
              ctx.beginPath();
              ctx.lineWidth = lineWidth;
              ctx.strokeStyle = strokeColor;
              ctx.moveTo(pos.x, pos.y);
              setPosition(e);
              ctx.lineTo(pos.x, pos.y);
              ctx.stroke();
            }

            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            function fillMaxNumPages() {
                axios.get("http://127.0.0.1:10001/numpages/" + flipbookName).then(function (resp) {
                    if(resp.data == "0") {
                        document.getElementById("spanMaxPages").innerHTML = 1;
                    } else {
                        document.getElementById("spanMaxPages").innerHTML = resp.data;
                    }
                });
            }

            function exportCanvas() {
                pngImg = canvas.toDataURL("image/png");
                var currentPage = parseInt(document.getElementById("spanCurrentPage").innerHTML.trim());
                axios.post("http://127.0.0.1:10001/flipbooks/" + flipbookName + "/" + currentPage, {
                    img: pngImg,
                }).then(function (response) {
                    console.log("Successfully saved image");
                });
            }

            function importCanvas() {
                var currentPage = parseInt(document.getElementById("spanCurrentPage").innerHTML.trim());
                axios.get("http://127.0.0.1:10001/flipbooks/" + flipbookName + "/" + currentPage).then(function (resp) {
                    console.log(resp.data);
                    var image = new Image();
                    image.src = resp.data;
                    image.onload = function() {
                        ctx.drawImage(image, 0, 0);
                    };
                });
            }

            function createPage() {
                // Save current canvas before making a new page
                this.exportCanvas();
                this.clearCanvas();
                var currentPage = parseInt(document.getElementById("spanCurrentPage").innerHTML.trim());
                document.getElementById("spanCurrentPage").innerHTML = currentPage + 1;

                var maxPage = parseInt(document.getElementById("spanMaxPages").innerHTML.trim());
                document.getElementById("spanMaxPages").innerHTML = maxPage + 1;
                // Export blank canvas to hold place
                this.exportCanvas();

            }

            function nextPage() {
                this.exportCanvas();
                this.clearCanvas();
                var currentPage = parseInt(document.getElementById("spanCurrentPage").innerHTML.trim());
                document.getElementById("spanCurrentPage").innerHTML = currentPage + 1;
                this.importCanvas();
            }

            function previousPage() {
                this.exportCanvas();
                this.clearCanvas();
                var currentPage = parseInt(document.getElementById("spanCurrentPage").innerHTML.trim());
                document.getElementById("spanCurrentPage").innerHTML = currentPage - 1;
                this.importCanvas();
            }

        </script>
    </head>
    <body onload="init()">
        <div>
            <div id="canvasDiv">
                <canvas id="canvas"></canvas>
            </div>
            <div class="bordered">
                <p id="pLastCommand" class="nonSelectable">
                    Awaiting Voice Command (try saying "color red")
                </p>
            </div>
        </div>
        <div>
            <p>Flipbook name: <span id="spanFlipbookName">{{ flipbookName }}</span> </p>
            <p>Page <span id="spanCurrentPage">1</span>/<span id="spanMaxPages">-1</span>
            <button onClick="exportCanvas()">Test</button>
            <button onClick="importCanvas()">Import Canvas</button>
            <button onClick="createPage()">Create Page</button>
            <button onClick="nextPage()">Next Page</button>
            <button onClick="previousPage()">Previous Page</button>
        </div>
    </body>

</html>

